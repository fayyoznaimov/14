{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Заявки</h3>
  <div>
    <a href="/admin/complaints" class="btn btn-sm btn-outline-light {% if not category %}disabled{% endif %}">Все</a>
    <a href="/admin/complaints?category=complaint" class="btn btn-sm btn-outline-light {% if category=='complaint' %}disabled{% endif %}">Жалобы</a>
    <a href="/admin/complaints?category=suggestion" class="btn btn-sm btn-outline-light {% if category=='suggestion' %}disabled{% endif %}">Предложения</a>
  </div>
</div>

<div class="card p-2">
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead><tr><th>№</th><th>Пользователь</th><th>Категория</th><th>Статус</th><th>Дата</th><th>Текст</th><th>Действия</th></tr></thead>
      <tbody>
      {% for r in rows %}
        {% set id, ticket, uid, un, fn, cat, textval, ftype, status, created = r %}
        <tr>
          <td><span class="text-light fw-semibold">{{ ticket }}</span></td>
          <td><div><code>{{ uid }}</code></div><div class="muted">{{ un or '-' }} {{ fn or '' }}</div></td>
          <td>{{ 'жалоба' if cat=='complaint' else 'предложение' }}</td>
          <td><span class="badge status-{{ status }}">{{ status }}</span></td>
          <td>{{ created.strftime("%Y-%m-%d %H:%M") }}</td>
          <td style="max-width:420px">{{ (textval or '')[:140] }}{% if (textval or '')|length > 140 %}…{% endif %}</td>
          <td>
            <form method="post" action="/admin/complaints/status" class="d-flex gap-1">
              <input type="hidden" name="ticket_no" value="{{ ticket }}">
              <select class="form-select form-select-sm" name="status">
                {% for st in ['new','in_progress','done'] %}
                  <option value="{{ st }}" {% if st==status %}selected{% endif %}>{{ st }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-primary">OK</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between">
    <a class="btn btn-sm btn-outline-light {% if page<=1 %}disabled{% endif %}" href="/admin/complaints?page={{ page-1 }}{% if category %}&category={{ category }}{% endif %}">← Назад</a>
    <a class="btn btn-sm btn-outline-light" href="/admin/complaints?page={{ page+1 }}{% if category %}&category={{ category }}{% endif %}">Вперёд →</a>
  </div>
</div>
{% endblock %}
